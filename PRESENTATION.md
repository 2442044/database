# データベース講義 最終課題発表
## タイトル：小規模店舗向けDVDレンタル管理システムの設計と実装 ～RDBとVector DBのハイブリッド構成～

---

### 1. はじめに

本日は、個人経営のDVDレンタルショップをターゲットとした管理システムの開発について発表します。
開発の背景には、既存の手書きや古いPCソフトによる管理からの脱却を目指す店舗オーナー（ペルソナ：山田勇太さん）の存在があります。
本システムは、在庫管理の効率化と、顧客体験を向上させるための「AI検索機能」を低コストで実現することを目標としました。

---

### 2. システムアーキテクチャ

本システムは以下の技術スタックで構成されています。

*   **フレームワーク**: Flask (Python) - 軽量かつ拡張性が高いため採用
*   **データベース**: SQLite - セットアップが容易で、小規模な店舗運用に最適
    *   **RDB**: 業務データ（ユーザー、商品、貸出履歴）の管理
    *   **Vector DB**: AI検索用のベクトルデータ管理
*   **環境構築**: Docker - どのPCでも同じ環境で即座に動作可能（OTA更新も視野）

---

### 3. データベース詳細設計 (RDB)

リレーショナルデータベース (`dvd_rental.db`) は、データの整合性を最優先に設計しました。以下に主要な4つのテーブルとその設計意図を解説します。

#### 3.1 テーブル構成と正規化

1.  **genres (ジャンルテーブル)**
    *   DVDのジャンル名を管理します。
    *   **設計意図**: 第3正規形を適用し、`dvds` テーブルからジャンル名を分離しました。これにより、ジャンル名の変更（例: "Sci-Fi" → "SF"）があった場合でも、このテーブルの1レコードを更新するだけで済み、更新時異常を防ぎます。

2.  **dvds (DVDテーブル)**
    *   DVDの基本情報（タイトル、在庫数、説明文など）を管理します。
    *   **設計意図**: `genre_id` を外部キーとして持ち、ジャンルテーブルとリレーションを結んでいます。また、`stock_count`（現在庫）と `total_stock`（総在庫）を分けることで、貸出可能数を即座に把握できるようにしました。

3.  **users (ユーザーテーブル)**
    *   会員情報を管理します。
    *   **設計意図**: `member_code` と `phone` カラムに `UNIQUE` 制約を付与しました。これにより、会員コードや電話番号の重複登録をデータベースレベルで防止すると同時に、自動的にインデックスが作成され、検索パフォーマンスが向上しています（DB Tuning）。

4.  **rentals (レンタルテーブル)**
    *   貸出・返却の履歴を管理します。
    *   **設計意図**: ユーザーとDVDの多対多の関係を解消する中間テーブル（交差エンティティ）としての役割を果たします。`rental_date`（貸出日）や `return_date`（返却日）を持ち、履歴データとしても機能します。

#### 3.2 データの整合性とトランザクション

貸出処理 (`rent_dvd`) においては、データの不整合を絶対に避ける必要があります。
本システムでは、以下の処理を1つのトランザクションとして実行しています。

1.  `rentals` テーブルへのレコード挿入（貸出記録）
2.  `dvds` テーブルの `stock_count` 減算（在庫更新）

`BEGIN TRANSACTION` から `COMMIT` までの間にエラーが発生した場合は `ROLLBACK` することで、「記録は残ったが在庫が減っていない」といった矛盾が発生しないよう保証しています。

---

### 4. AI検索機能の実装 (Vector DB & RAG)

本システムの最大の特徴は、従来のキーワード検索に加えて、**ベクトル検索（AI検索）** を導入した点です。

#### 4.1 導入の背景
従来のSQLによる `LIKE` 検索（キーワード一致）では、「泣ける映画」や「家族で楽しめる」といった抽象的な要望には応えられませんでした。そこで、文章の意味をベクトル（数値の羅列）として捉える Vector DB の技術を採用しました。

#### 4.2 実装の仕組み
*   **ベクトル化**: Pythonライブラリ `sentence-transformers` を使用し、DVDのタイトル・ジャンル・説明文を384次元のベクトルに変換します。
*   **Vector DB**: `dvd_vector.db` (SQLite) に、DVD ID とベクトルデータ（BLOB型）をペアで保存します。
*   **検索ロジック**: ユーザーの入力クエリも同様にベクトル化し、登録データとの「コサイン類似度」を計算することで、意味的に近い作品を抽出します。

#### 4.3 精度向上のための工夫（ハイブリッド検索）
単なるベクトル検索だけでは、「ジブリ」と検索した際に、作風が似ているだけの他作品もヒットしてしまう課題がありました。
そこで、以下の**ハイブリッド検索ロジック**を実装しました。

1.  ベクトル検索で候補を取得。
2.  候補の中で、タイトルや説明文に検索キーワードが**直接含まれている作品のスコアをプログラム側で加算（ブースト）**。

この工夫により、「あいまい検索の柔軟性」と「キーワード検索の確実性」を両立させることができました。

---

### 5. まとめ

本システムは、基本的なRDB設計（正規化、外部キー、トランザクション）を忠実に実装しつつ、Vector DBという最新技術を組み合わせることで、実用的かつ先進的な店舗管理システムとなりました。
データベース講義で学んだ知識が、実際のアプリケーション開発においてデータの整合性維持や検索性能の向上に直結していることを実感しました。

以上で発表を終わります。
